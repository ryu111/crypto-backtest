# 回測系統長期路線圖 (2026)

## 狀態總覽

| Phase | 名稱 | 狀態 | 優先順序 |
|-------|------|------|----------|
| 7 | 統一介面與類型修復 | ✅ 已完成 | - |
| 8 | 回測驗證系統 | 🔲 待開始 | **P0 (最高)** |
| 9 | 效能基準測試 | 🔲 待開始 | P1 |
| 10 | 策略漸進式 Polars 化 | 🔲 待開始 | P2 |
| 11 | 進階功能開發 | 🔲 待開始 | P3 |

---

## 記錄表：待辦選項分析

### 選項 A：回測驗證系統 ⭐ 建議優先

| 層級 | 名稱 | 驗證內容 | 複雜度 | 價值 |
|------|------|----------|--------|------|
| L1 | 過程正確性 | 訊號生成、訂單執行、費率計算 | 中 | **極高** |
| L2 | 數值正確性 | Sharpe/MaxDD/Return 計算驗證 | 低 | 高 |
| L3 | 統計正確性 | WFA、Monte Carlo、過擬合檢測 | 高 | 高 |

**為什麼優先？**
- 🎯 沒有驗證系統，無法確認其他功能的正確性
- 🎯 是所有後續開發的「信任基礎」
- 🎯 發現 bug 的成本：現在 < 未來

### 選項 B：效能基準測試

| 測試項目 | 說明 | 複雜度 | 價值 |
|----------|------|--------|------|
| Pandas vs Polars 對比 | 同策略、同資料的速度對比 | 低 | 中 |
| GPU 加速效果 | MLX/MPS 批量回測效能 | 中 | 中 |
| 並行效率 | 多核心利用率 | 低 | 中 |
| 記憶體使用 | 大資料集記憶體效率 | 低 | 低 |

**依賴關係**：需要先有驗證系統確認結果一致性

### 選項 C：策略漸進式 Polars 化

| 策略 | 目前狀態 | Polars 化難度 | 優先級 |
|------|----------|--------------|--------|
| MACross | Pandas (fallback) | 低 | 中 |
| RSI | Pandas (fallback) | 低 | 中 |
| MACD | Pandas (fallback) | 低 | 中 |
| Supertrend | Pandas (fallback) | 中 | 低 |
| Stochastic | Pandas (fallback) | 低 | 低 |
| Donchian | Pandas (fallback) | 低 | 低 |
| Bollinger | Pandas (fallback) | 低 | 低 |
| RSI Reversion | Pandas (fallback) | 低 | 低 |
| ETH/BTC Pairs | Pandas (fallback) | 高 | 低 |
| Basis Arb | Pandas (fallback) | 高 | 低 |
| Funding Arb | Pandas (fallback) | 中 | 低 |
| Settlement | Pandas (fallback) | 中 | 低 |

**依賴關係**：需要效能基準來量化改進效果

### 選項 D：進階功能開發

| 功能 | 說明 | 複雜度 | 價值 | 依賴 |
|------|------|--------|------|------|
| Regime Detection | 市場狀態識別 | 高 | **極高** | 驗證系統 |
| 多目標優化 | Pareto 最優參數 | 中 | 高 | 驗證系統 |
| 策略組合優化 | 投資組合權重 | 高 | 高 | Regime Detection |
| 實時交易整合 | 連接交易所 API | 極高 | 極高 | 所有以上 |

---

## 建議執行順序

```
Phase 8: 回測驗證系統 (P0)
    │
    ├── 8.1 過程正確性驗證
    │   ├── 訊號一致性測試
    │   ├── 訂單執行驗證
    │   └── 費率計算驗證
    │
    ├── 8.2 數值正確性驗證
    │   ├── 績效指標計算測試
    │   └── 與手動計算對照
    │
    └── 8.3 統計正確性驗證
        ├── WFA 結果驗證
        └── Monte Carlo 分佈驗證
    │
    ▼
Phase 9: 效能基準測試 (P1)
    │
    ├── 9.1 建立基準測試框架
    ├── 9.2 Pandas vs Polars 對比
    ├── 9.3 GPU 加速效果測量
    └── 9.4 產出效能報告
    │
    ▼
Phase 10: 策略漸進式 Polars 化 (P2)
    │
    ├── 10.1 核心策略 Polars 化 (MA, RSI, MACD)
    ├── 10.2 次要策略 Polars 化
    └── 10.3 效能驗證 (與 Phase 9 對比)
    │
    ▼
Phase 11: 進階功能開發 (P3)
    │
    ├── 11.1 Regime Detection
    ├── 11.2 多目標優化
    ├── 11.3 策略組合優化
    └── 11.4 實時交易整合 (長期)
```

---

## 長期 Phase 規劃

### Phase 8: 回測驗證系統（建議 1-2 週）

**目標**：建立可信賴的驗證基礎

| 任務 | 檔案 | 說明 |
|------|------|------|
| 8.1.1 | `src/backtester/validator.py` | BacktestValidator 主類別 |
| 8.1.2 | `src/backtester/validator.py` | 訊號一致性測試 |
| 8.1.3 | `src/backtester/validator.py` | 訂單執行驗證 |
| 8.1.4 | `src/backtester/validator.py` | 費率計算驗證 |
| 8.2.1 | `src/backtester/validator.py` | 績效指標計算驗證 |
| 8.2.2 | `tests/test_validator.py` | 手動計算對照測試 |
| 8.3.1 | `src/backtester/validator.py` | WFA 驗證 |
| 8.3.2 | `src/backtester/validator.py` | Monte Carlo 驗證 |
| 8.4.1 | `tests/test_integration_validator.py` | 整合測試 |

**驗收標準**：
- [x] 100% 策略通過訊號一致性測試
- [x] 績效指標與手動計算誤差 < 0.01%
- [x] WFA/MC 結果可重現

### Phase 9: 效能基準測試（建議 3-5 天）

**目標**：量化效能，找出瓶頸

| 任務 | 檔案 | 說明 |
|------|------|------|
| 9.1.1 | `src/benchmark/framework.py` | 基準測試框架 |
| 9.1.2 | `src/benchmark/runners.py` | 測試執行器 |
| 9.2.1 | `benchmarks/pandas_vs_polars.py` | Pandas/Polars 對比 |
| 9.3.1 | `benchmarks/gpu_acceleration.py` | GPU 加速測試 |
| 9.4.1 | `docs/performance_report.md` | 效能報告 |

**驗收標準**：
- [ ] 產出完整效能報告
- [ ] 識別 Top 3 效能瓶頸
- [ ] 確認 Polars/GPU 加速效果

### Phase 10: 策略漸進式 Polars 化（建議 1-2 週）

**目標**：提升策略執行效率

| 任務 | 檔案 | 說明 |
|------|------|------|
| 10.1.1 | `src/strategies/trend/ma_cross.py` | MA Cross Polars 化 |
| 10.1.2 | `src/strategies/momentum/rsi.py` | RSI Polars 化 |
| 10.1.3 | `src/strategies/momentum/macd.py` | MACD Polars 化 |
| 10.2.x | 其他策略 | 逐步 Polars 化 |
| 10.3.1 | 效能驗證 | 與 Phase 9 基準對比 |

**驗收標準**：
- [ ] 核心策略完全支援 Polars
- [ ] 效能提升 > 2x
- [ ] 所有測試通過

### Phase 11: 進階功能開發（長期）

**目標**：提升系統智能化程度

| 子 Phase | 功能 | 預估時間 |
|----------|------|----------|
| 11.1 | Regime Detection | 2-3 週 |
| 11.2 | 多目標優化 | 1-2 週 |
| 11.3 | 策略組合優化 | 2-3 週 |
| 11.4 | 實時交易整合 | 4-6 週 |

---

## 優先順序決策邏輯

```
                     ┌─────────────────────┐
                     │ 目前系統可信嗎？    │
                     └─────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
           不確定                            確定
              │                               │
              ▼                               ▼
    ┌─────────────────────┐       ┌─────────────────────┐
    │ Phase 8: 驗證系統   │       │ 效能夠快嗎？        │
    │ (建立信任基礎)      │       └─────────────────────┘
    └─────────────────────┘                   │
                                  ┌───────────┴───────────┐
                                  ▼                       ▼
                               不夠快                    夠快
                                  │                       │
                                  ▼                       ▼
                    ┌─────────────────────┐   ┌─────────────────────┐
                    │ Phase 9-10: 效能    │   │ Phase 11: 新功能    │
                    │ 優化                │   │ 開發                │
                    └─────────────────────┘   └─────────────────────┘
```

**核心邏輯**：
1. **信任 > 速度 > 功能**
2. 沒有驗證，速度再快也可能是錯的
3. 沒有效能，功能再多也跑不動

---

## 執行建議

### 立即開始（本週）

1. **Phase 8.1: 過程正確性驗證**
   - 建立 `BacktestValidator` 類別
   - 實作訊號一致性測試
   - 驗證訂單執行邏輯

### 短期（1-2 週）

2. **Phase 8.2-8.3: 完成驗證系統**
   - 數值正確性驗證
   - 統計正確性驗證

### 中期（2-4 週）

3. **Phase 9: 效能基準測試**
4. **Phase 10: 策略 Polars 化**

### 長期（1-3 個月）

5. **Phase 11: 進階功能**

---

## 風險評估

| 風險 | 影響 | 緩解措施 |
|------|------|----------|
| 驗證發現重大 bug | 高 | 早期發現 = 早期修復 |
| Polars 化不如預期 | 中 | 有 fallback 機制 |
| 新功能複雜度高 | 中 | 分階段實作 |
| 時間估計偏差 | 低 | 使用迭代式開發 |

---

## 決策點

在開始前需要確認：

1. **驗證深度**：L1+L2 足夠，還是需要完整 L1+L2+L3？
2. **效能目標**：期望的加速倍數？
3. **功能優先級**：Regime Detection vs 多目標優化 哪個先？

---

*建立日期：2026-01-13*
*最後更新：2026-01-13*
